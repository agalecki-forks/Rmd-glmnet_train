---
title: 'Cox Models multiple -preamble'
author: "Chunyi Wu and Andrzej Galecki"
date: "`r format(Sys.Date())`"
output:
  rmdformats::readthedown:
    lightbox: true
    use_bookdown: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment="#>")
```


<!-- ========== Read raw data   ================= -->

# Read raw data

```{r  Read-raw-data}
excel_datain <- "./Data/data_example.xlsx"
dt <- read_excel(excel_datain)
```

## Data prep. 

* Data are prepared for Cox regression.        
```{r data-prep}
 dt <- dt  %>% rename(time = FU_TIME, status = CASE_CONTROL) %>% 
  mutate(log10_DU_ACR = log10(DU_ACR))  %>% filter(time>0) %>% filter(BL_eGFR >= 45)

dim(dt) # Number of rows and columns in the input data
```


## Variables

```{r Variables-used-Cox-model}
prot_npx <- c("KIM1.npx","SYND1.npx","IL.1RT1.npx",   "WFDC2.npx", "CD27.npx",
              "TNFRSF10A.npx","LAYN.npx","PVRL4.npx", "EDA2R.npx","TNFRSF4.npx",
              "GFR_alpha_1_npx","TNF.R1.npx","PI3_npx", "EFNA4.npx","TNF.R2.npx" ,
              "DLL1.npx", "TNFRSF6B.npx", "CD160.npx", "EPHA2.npx","RELT.npx",
              "LTBR.npx") 
surv_vars <-  c("time", "status")
clin_vars <- c("BL_eGFR","B_HBA1C_PRC","log10_DU_ACR")  ## excluded,"SEX","AGE_TL")
xvars <- c(clin_vars, prot_npx)
vars <- c(surv_vars, prot_npx, clin_vars) # For Model M2
clin_vars
```


## Create dataset `datax`

* Create dataset `datax` that contains subset of all vars needed for the analysis.

```{r data-prep1}
datax <- dt  %>% select(all_of(vars)) 
dim(datax)         
```


## Complete cases

* Keep rows with complete cases in `train_data` dataframe.


```{r data-prep2}
#drop any records with NA
train_data <- datax %>% drop_na()    
```

## survSplit-cut

```{r survSplit-cut}
survSplit_cut <- 10  # Time horizon 10 years
```

## Create `train_data15`

* Create data that is censored at `r survSplit_cut` years (prediction horizon)
* extra varibles are created

```{r survSplit}
temp <- survSplit(Surv(time,  status) ~ ., data = train_data, cut = survSplit_cut,
                  episode = "epsd")
dim(train_data)

train_data15 <- subset(temp, epsd == 1)  # only the first ?? years
dim(train_data15)
names(train_data15)
train_data_saved    <- train_data15
```

## Selected vriables

```{r head15}
range(train_data15$time)
range(train_data15$epsd)
tt <- train_data15 %>% select(BL_eGFR, tstart, time, status, epsd)
head(tt)
tail(tt)
```

## X matrix

* Use `train_data15` to create X matrix and Surv object required by `glmnet`.

```{r model-mtx}
# Create X matrix
# -dtx <- subset(train_data, select=-c(time,status))
dtx <- train_data15 %>% select(all_of(xvars)) 
x <- model.matrix(~0 +., data=dtx)
dim(x)
colnames(x)
```

## Create Surv object

```{r surv-object}
y <- data.matrix(train_data15[,c("time", "status")])
ySurv <- survival::Surv(y[,"time"], y[, "status"])
```

## Create cv-folds 

* (nfolds = 10 is default in `cv.glmnet`)

```{r foldid-1}
set.seed(1234)
nfolds <-10
foldid <- sample(1:nfolds, size = nrow(train_data15), replace=TRUE)
length(foldid)
```

* Table with fold sizes is included below.

```{r foldid-2}
tibble(foldid = foldid) %>% group_by(foldid) %>% count()
```

#  LASSO


* lasso with penalty.factor

* Clinical covariates forced into the model

## glmnet

```{r beta1}
clin_vars
ncolx <- length(colnames(x))
pen <- rep(1, times= ncolx)
pen[1:length(clin_vars)] <- 0
fit1 <- glmnet(x, ySurv, family = "cox", alpha=1, penalty.factor = pen)
(gl_fit1 <- myglance(fit1))

plot(fit1)
```
# cv.glmnet

```{r cv-fit1}
cvfit1 <- cv.glmnet(x, ySurv, family = "cox", alpha=1, penalty.factor = pen, foldid =foldid)
cvfit1
(mygl1 <- myglance(cvfit1))
log(mygl1[,c("lambda.min", "lambda.1se")]) # log(lambda)
mytidy(cvfit1)

td_cvfit1 <- mytidy_Surv(cvfit1, x, ySurv)
td_cvfit1$comment <- "LASSO-ALL"
beta1 <- td_cvfit1 %>% select(c(step,lambda, nzero, beta, mincv, comment)) %>% unnest(beta) %>% group_by(step) 

beta1

beta1 %>% filter(mincv == "1se")
beta1 %>% filter(mincv == "min")



plot(cvfit1)
```

